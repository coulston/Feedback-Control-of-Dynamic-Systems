\usetikzlibrary{patterns}
\usetikzlibrary{decorations.pathmorphing}
\mode<presentation>
{
  \usetheme{CambridgeUS}
  \usecolortheme{whale}
  \usecolortheme{lily}

  \setbeamercovered{transparent}
  \usefonttheme[onlymath]{serif}
}

\title[PID] % (optional, use only with long paper titles)
{EGGN307: Proportional, Integral, Derivative (PID) control}

\subtitle
{} % (optional)

\author% (optional, use only with lots of authors)
{T. Vincent}
%{T. Vincent\inst{1} \and S.~Another\inst{2}}
% - Use the \inst{?} command only if the authors have different
%   affiliation.

\institute[CSM] % (optional, but mostly needed)
{Division of Engineering\\
  Colorado School of Mines}
% - Use the \inst command only if there are several affiliations.
% - Keep it simple, no one is interested in your street address.

\date % (optional)
{Lecture 19}



% If you have a file called "university-logo-filename.xxx", where xxx
% is a graphic format that can be processed by latex or pdflatex,
% resp., then you can add a logo as follows:

%\pgfdeclareimage[height=1.1cm]{university-logo}{UniversityLogo}
%\logo{\pgfuseimage{university-logo}}



% Delete this, if you do not want the table of contents to pop up at
% the beginning of each subsection:
%\AtBeginSection[]
%{
%  \begin{frame}<beamer>{Outline}
%    \tableofcontents[currentsection,currentsubsection]
%  \end{frame}
%}


% If you wish to uncover everything in a step-wise fashion, uncomment
% the following command:

%\beamerdefaultoverlayspecification{<+->}


\begin{document}

\begin{frame}
  \titlepage
\end{frame}

\mode<article>{
\maketitle
\tableofcontents
}

%\mode<presentation>{
%\begin{frame}{Outline}
%  \tableofcontents
%  % You might wish to add the option [pausesections]
%\end{frame}}

\section{Intro to PID}

\begin{frame}{Three term control}
\begin{itemize}
\item Many systems are first or second order, or have dominant second order dynamics
\begin{itemize}
\item 1 or 2 tank system
\item Motor with inertial load
\item Mass, spring, damper system
\item Satellite
\end{itemize}
\item Common control objectives are to:
\begin{itemize}
\item Follow a step command
\item Reject step disturbances
\end{itemize}
\item PID control is a control scheme that works well in these situations 
\end{itemize}
\end{frame}

\begin{frame}{System to be Controlled}
\begin{center}
\begin{tikzpicture}[scale=1,inner sep=0pt,outer sep=0pt,very thick,
sysblock/.style={draw,rectangle,inner sep=2pt,minimum width=1.5cm,minimum height=1.25cm,very thick}]

\draw (7,0) node[draw,circle] (sum2) {$\rule{0pt}{18pt}$};
\draw (9,0) node[sysblock] (G) {$G(s)$};

\draw[->] (5,0) -- node[above=2pt,pos=.5] {$U(s)$} (sum2.180) node[above left=2pt] {$+$};
\draw[->] (sum2.0) -- (G);
\draw[->] (G) -- ++(2.5,0) node[above=2pt] {$Y(s)$};
\draw[<-] (sum2.90) node[above right=2pt] {$+$} -- ++(0,1) node[right=2pt] {$D(s)$};
\end{tikzpicture}
\end{center}
\begin{itemize}
\item $G(s)= \frac{A}{s^{2}+a_{1}s+a_{0}}$
\item Disturbance modeled as input disturbance
\item $U(s)$ - actuator command
\item $Y(s)$ - output to be regulated
\end{itemize}
\end{frame}

\section{Proportional Control}
\begin{frame}{Proportional Control}
\begin{tikzpicture}[scale=1,inner sep=0pt,outer sep=0pt,very thick,
sysblock/.style={draw,rectangle,inner sep=2pt,minimum width=1.5cm,minimum height=1.25cm,very thick}]

\draw (1.25,0) node[draw,circle] (sum1) {$\rule{0pt}{18pt}$};
\draw (4,0) node[sysblock] (Kp) {$K_{p}$};
\draw (7,0) node[draw,circle] (sum2) {$\rule{0pt}{18pt}$};
\draw (9,0) node[sysblock] (G) {$G(s)$};

\draw[->] (0,0) node[above=2pt] {$R(s)$} -- (sum1.180) node[above left=2pt] {$+$};
\draw[->] (sum1.0) --  node[above=2pt,pos=.5] {$E(s)$} (Kp);
\draw[->] (Kp) -- node[above=2pt,pos=.5] {$U(s)$} (sum2.180) node[above left=2pt] {$+$};
\draw[->] (sum2.0) -- (G);
\draw[->] (G) -- ++(2.5,0) node[above=2pt] {$Y(s)$};
\draw[->] (G) ++(1.5,0) -- ++(0,-2) -| (sum1.-90) node[below right=2pt] {$-$};
\draw[<-] (sum2.90) node[above right=2pt] {$+$} -- ++(0,1) node[right=2pt] {$D(s)$};
\end{tikzpicture}
\begin{itemize}
\item Actuator command is {\em proportional} to error between system output and reference
\item Two important transfer functions: $\frac{Y(s)}{R(s)}$ and $\frac{E(s)}{D(s)}$
\end{itemize}
\end{frame}

\begin{frame}{Closed loop transfer functions}
\begin{itemize}
\item Command to output
\begin{align*}
\frac{Y(s)}{R(s)} &= \frac{K_{p}G(s)}{1+K_{p}G(s)} \\
& = \frac{\frac{AK_{p}}{s^{2}+a_{1}s+a_{0}}}{1+\frac{AK_{p}}{s^{2}+a_{1}s+a_{0}}} \\
& = \frac{AK_{p}}{s^{2} +a_{1}s + (a_{0}+AK_{p})}
\end{align*}
\item $\omega_{n} = \sqrt{a_{0}+AK_{p}}$, $\zeta = a_{1}/(2\sqrt{a_{0}+AK_{p}})$
\item Increasing $K_{p}$ increases step response speed, but reduces damping ratio
\end{itemize}
\end{frame}

\begin{frame}{Closed loop transfer functions}
\begin{itemize}
\item Disturbance to tracking error
\begin{align*}
\frac{E(s)}{D(s)} &= -\frac{G(s)}{1+K_{p}G(s)} \\
& =- \frac{A}{s^{2}+a_{1}s+a_{0}+AK_{p}} \\
\end{align*}
\item If $D(s)=\frac{1}{s}$, $\lim_{t\rightarrow \infty}e(t) = \frac{A}{a_{0}+AK_{p}}$
\item Increasing $K_{p}$ reduces error to step disturbance
\end{itemize}
\end{frame}

\begin{frame}{Proportional Control using Mechanical Elements}
Mass spring damper system
\begin{center}
\begin{tikzpicture}[scale=1.75,inner sep=0pt,outer sep=0pt,very thick]
\draw (.3,0) node[fill] (a) {}; 
\draw (1.7,0) node[fill] (b) {};
 
\draw (0,0) node (gnd1) {\input{../../../Tikzmodeling/MechanicalElements/ground.tex}};
\draw (1,.3) node (K1) {\input{../../../Tikzmodeling/MechanicalElements/spring.tex}};
\draw (1,.3) node[above=.2in] {$k$};
\draw (1,-.3) node (D) {\input{../../../Tikzmodeling/MechanicalElements/damper.tex}};
\draw (1,-.3) node[below=.22in] {$b$};
\draw (2.5,0) node (M1) {\input{../../../Tikzmodeling/MechanicalElements/mass2.tex}};
\draw (2.5,0) node {$m$};
\draw[|->] (2.5,.8) node[above=.15in] {$y$} -- ++(.5,0);


\draw (gnd1) -- (a);
\draw (a) |- (K1);
\draw (a) |- (D);
\draw (K1) -| (b);
\draw (D) -| (b);
\draw (b) -- (M1);
\draw[->] (M1.0) ++(0,.4) -- ++(.5,0) node[right] {$d$};
\draw[->] (M1.0) -- ++(.5,0) node[right] {$u$};

\end{tikzpicture}
\end{center}
\[
\frac{Y(s)}{U(s)} = \frac{1/m}{s^{2}+(b/m)s + (k/m)}
\]
\end{frame}


\begin{frame}{Proportional Control using Mechanical Elements}
Mass spring damper with extra spring with settable reference position
\begin{center}
\begin{tikzpicture}[scale=1.75,inner sep=0pt,outer sep=0pt,very thick]
\draw (.3,0) node[fill] (a) {}; 
\draw (1.7,0) node[fill] (b) {};
 
\draw (0,0) node (gnd1) {\input{../../../Tikzmodeling/MechanicalElements/ground.tex}};
\draw (1,.3) node (K1) {\input{../../../Tikzmodeling/MechanicalElements/spring.tex}};
\draw (1,.3) node[above=.2in] {$k$};
\draw (1,-.3) node (D) {\input{../../../Tikzmodeling/MechanicalElements/damper.tex}};
\draw (1,-.3) node[below=.22in] {$b$};
\draw (2.5,0) node (M1) {\input{../../../Tikzmodeling/MechanicalElements/mass2.tex}};
\draw (2.5,0) node {$m$};
\draw[|->] (2.5,.8) node[above=.15in] {$y$} -- ++(.5,0);
\draw (4,0) node (K2) {\input{../../../Tikzmodeling/MechanicalElements/spring.tex}};
\draw (4,0) node[above=.2in] {$K_p$};


\draw (gnd1) -- (a);
\draw (a) |- (K1);
\draw (a) |- (D);
\draw (K1) -| (b);
\draw (D) -| (b);
\draw (b) -- (M1);
\draw (M1) -- (K2);
\draw[->] (M1.0) ++(0,.4) -- ++(.5,0) node[right] {$d$};
\draw[-o] (K2.0) -- ++(.5,0);
\draw[|->] (K2.0) ++(.42,.2) node[above=.15in] {$r$} -- ++(.5,0);

\end{tikzpicture}
\end{center}
\[
u(t) = K_{p}(r(t)-y(t))
\]
\begin{itemize}
\item System can be represented as proportional feedback control loop 
\end{itemize}
\end{frame}

\section{Proportional/Derivative Control}

\begin{frame}{Proportional/Derivative (PD) Control }
\begin{tikzpicture}[scale=1,inner sep=0pt,outer sep=0pt,very thick,
sysblock/.style={draw,rectangle,inner sep=2pt,minimum width=1.5cm,minimum height=1.25cm,very thick}]

\draw (1.25,0) node[draw,circle] (sum1) {$\rule{0pt}{18pt}$};
\draw (3.5,0) node[sysblock] (Kp) {$K_{p}$};
\draw (5,0) node[draw,circle] (sum3) {$\rule{0pt}{18pt}$};
\draw (7,0) node[draw,circle] (sum2) {$\rule{0pt}{18pt}$};
\draw (9,0) node[sysblock] (G) {$G(s)$};
\draw (8,-1.75) node[sysblock] (Kd) {$K_{d}s$};

\draw[->] (0,0) node[above=2pt] {$R(s)$} -- (sum1.180) node[above left=2pt] {$+$};
\draw[->] (sum1.0) --  node[above=2pt,pos=.5] {$E(s)$} (Kp);
\draw[->] (Kp) -- (sum3.180) node[above left=2pt] {$+$};
\draw[->] (sum3.0) -- node[above=2pt,pos=.4] {$U(s)$}  (sum2.-180) node[above left=2pt] {$+$};
\draw[->] (sum2.0) -- (G);
\draw[->] (G) -- ++(2.5,0) node[above=2pt] {$Y(s)$};
\draw[->] (G) ++(1.5,0) |- (Kd) -| (sum3.-90) node[below right=2pt] {$-$};
\draw[->] (G) ++(1.5,0) -- ++(0,-3) -| (sum1.-90) node[below right=2pt] {$-$};
\draw[<-] (sum2.90) node[above right=2pt] {$+$} -- ++(0,1) node[right=2pt] {$D(s)$};
\end{tikzpicture}
\begin{itemize}
\item Goal: Speed up response without decreasing damping ratio
\item Modify command by subtracting {\em derivative} of output - if the output is moving quickly in the right direction, reduce command
\end{itemize}
\end{frame}

\begin{frame}{Mechanical Proportional/Derivative Control}
\begin{center}
\begin{tikzpicture}[scale=1.75,inner sep=0pt,outer sep=0pt,very thick]
\draw (.3,0) node[fill] (a) {}; 
\draw (1.7,0) node[fill] (b) {};
\draw (3.7,0) node[fill] (c) {};
 
\draw (0,0) node (gnd1) {\input{../../../Tikzmodeling/MechanicalElements/ground.tex}};
\draw (1,.3) node (K1) {\input{../../../Tikzmodeling/MechanicalElements/spring.tex}};
\draw (1,.3) node[above=.2in] {$k$};
\draw (1,-.3) node (D) {\input{../../../Tikzmodeling/MechanicalElements/damper.tex}};
\draw (1,-.3) node[below=.22in] {$b$};
\draw (2.5,0) node (M1) {\input{../../../Tikzmodeling/MechanicalElements/mass2.tex}};
\draw (2.5,0) node {$m$};
\draw[|->] (2.5,.8) node[above=.15in] {$y$} -- ++(.5,0);
\draw (4.5,-.3) node (K2) {\input{../../../Tikzmodeling/MechanicalElements/spring.tex}};
\draw (4.5,-.3) node[below=.2in] {$K_p$};
\draw (4.5,.3) node (D2) {\input{../../../Tikzmodeling/MechanicalElements/damper.tex}};
\draw (4.5,.3) node[above=.3in] {$K_d$};
\draw (5.5,.3) node[scale=.5,rotate=180] (gnd2) {\input{../../../Tikzmodeling/MechanicalElements/ground.tex}};

\draw (gnd1) -- (a);
\draw (a) |- (K1);
\draw (a) |- (D);
\draw (K1) -| (b);
\draw (D) -| (b);
\draw (b) -- (M1);
\draw (M1) -- (c);
\draw (c) |- (K2);
\draw (c) |- (D2);
\draw (D2) -- (gnd2);
\draw[->] (M1.0) ++(0,.4) -- ++(.5,0) node[right] {$d$};
\draw[-o] (K2.0) -- ++(.5,0);
\draw[|->] (K2.0) ++(.42,-.2) node[below=.15in] {$r$} -- ++(.5,0);

\end{tikzpicture}
\end{center}
\[
u(t) = K_{p}(r(t)-y(t)) - K_{d}\dot{y}(t)
\]

\end{frame}


\begin{frame}{Closed loop transfer functions}
\begin{itemize}
\item Inner loop
\begin{align*}
G_{I}(s)=\frac{G(s)}{1+K_{d}sG(s)} &= \frac{A}{s^{2}+(a_{1}+AK_{d})s +a_{0}}
\end{align*}
\item Command to output
\begin{align*}
\frac{Y(s)}{R(s)} &= \frac{K_{p}G_{I}(s)}{1+K_{p}G_{I}(s)}=\frac{K_{p}\frac{A}{s^{2}+(a_{1}+AK_{d})s + a_{0}}}{1+K_{p}\frac{A}{s^{2}+(a_{1}+AK_{d})s + a_{0}}}\\
& = \frac{AK_{p}}{s^{2} +(a_{1}+AK_{d})s + (a_{0}+AK_{p})}
\end{align*}
\item $\omega_{n} = \sqrt{a_{0}+AK_{p}}$, $\zeta = (a_{1}+AK_{d})/(2\sqrt{a_{0}+AK_{p}})$
\item Damping ratio can be increased by increasing $K_{d}$
\end{itemize}
\end{frame}

\begin{frame}{Closed loop transfer functions}
\begin{itemize}
\item Disturbance to tracking error
\begin{align*}
\frac{E(s)}{D(s)} &= -\frac{G_{I}(s)}{1+K_{p}G_{I}(s)} \\
& =- \frac{A}{s^{2}+(a_{1}+AK_{d})s+(a_{0}+AK_{p})} \\
\end{align*}
\item If $D(s)=\frac{1}{s}$, $\lim_{t\rightarrow 0}e(t) = \frac{A}{a_{0}+AK_{p}}$
\item Increasing $K_{p}$ reduces error to step disturbance, $K_{d}$ does not affect steady state error.
\end{itemize}
\end{frame}

\begin{example} Let's look at a motor positioning problem
\begin{frame}{Position control problem}
\begin{center}
\input{Graphics/motordiagram2.tex}
\end{center}
\end{frame}
The system parameters are: $R_{a}=1$, $L_{a}=0$, $J=1$, $b=2$, $K_{e}=K_{t}=1$. We want to design a controller so that the orientation $\theta$ will follow a command reference, with the following step response specifications:
\begin{itemize}
\item rise time, $t_{r}=.1$ s
\item overshoot, $\% OS=10\%$.
\end{itemize}
We found earlier that the (open loop) transfer function $\theta(s)/V_{a}(s)$ is
\[
\frac{\theta(s)}{V_{a}(s)} = \frac{K_{t}}{s((Js+b)(R_{a}+L_{a}s) +K_{t}K_{e})} = \frac{1}{s((s+2)+1)} = \frac{1}{s^{2}+3s}
\]	
We decide to use a $PD$ control structure, so the system block diagram looks like the following:
\begin{frame}{Position Control Block Diagram}
\begin{center}
\input{Graphics/PDexampleblockdiagram.tex}
\end{center}
\end{frame}
\end{example}
Because the system is second order with no zeros, it is possible to choose the gains $K_{p}$ and $K_{d}$ directly from the closed loop transfer function. In this case, the closed loop transfer function from the reference command is
\[
\frac{Y(s)}{R(s)} = \frac{1}{s^{2}+(3+K_{d})s+K_{p}}
\]
This looks like our canonical second order system
\[
G(s) = K\frac{\omega_{n}^{2}}{s^{2}+2\zeta\omega_{n}s+\omega_{n}^{2}}
\]
with $\omega_{n}^{2} = K_{p}$, $2\zeta\omega_{n} = 3+K_{d}$ and $K=1/K_{p}$.

To choose $K_{p}$ and $K_{d}$, we find a set of complex conjugate poles that will meet our specifications. Remember that we have already parameterized our specifications in terms of $\zeta$ and $\omega_{n}$:
\begin{itemize}
\item $t_{r} = \frac{1.8}{\omega_{n}} = .1$ implies $\omega_{n} = 18$
\item \% OS = 10 \% implies $\zeta = \frac{-\ln\left(\frac{10\%}{100 \%}\right)}{\sqrt{\ln\left(\frac{10\%}{100 \%}\right)^2+\pi^2}}=.59$
\end{itemize} 
Thus
\begin{align*}
K_{p}& = \omega_{n}^{2} = 18^2 = 324 \\
K_{d}& = 2\zeta\omega_{n} - 3 = 2(.59)(18) - 3 = 18.2
\end{align*}
\section{Proportional/Integral Control}
\begin{frame}{Proportional/Integral (PI) Control}
\begin{center}
\begin{tikzpicture}[scale=1,inner sep=0pt,outer sep=0pt,very thick,
sysblock/.style={draw,rectangle,inner sep=2pt,minimum width=1.5cm,minimum height=1.25cm,very thick}]
\draw (1.25,0) node[draw,circle] (sum1) {$\rule{0pt}{18pt}$};
\draw (3.5,0) node[sysblock] (Kp) {$K_{p}+\frac{K_{I}}{s}$};
%\draw (5,0) node[draw,circle] (sum3) {$\rule{0pt}{18pt}$};
\draw (6,0) node[draw,circle] (sum2) {$\rule{0pt}{18pt}$};
\draw (8,0) node[sysblock] (G) {$G(s)$};
%\draw (8,-1.75) node[sysblock] (Kd) {$K_{d}s$};
\draw[->] (0,0) node[above=2pt] {$R(s)$} -- (sum1.180) node[above left=2pt] {$+$};
\draw[->] (sum1.0) --  node[above=2pt,pos=.5] {$E(s)$} (Kp);
%\draw[->] (Kp) -- (sum3.180) node[above left=2pt] {$+$};
\draw[->] (Kp.0) -- node[above=2pt,pos=.4] {$U(s)$}  (sum2.-180) node[above left=2pt] {$+$};
\draw[->] (sum2.0) -- (G);
\draw[->] (G) -- ++(2.5,0) node[above=2pt] {$Y(s)$};
%\draw[->] (G) ++(1.5,0) |- (Kd) -| (sum3.-90) node[below right=2pt] {$-$};
\draw[->] (G) ++(1.5,0) -- ++(0,-2) -| (sum1.-90) node[below right=2pt] {$-$};
\draw[<-] (sum2.90) node[above right=2pt] {$+$} -- ++(0,1) node[right=2pt] {$D(s)$};
\end{tikzpicture}
\end{center}
\begin{itemize}
\item Goal: Speed up response without decreasing damping ratio, while meeting steady state error specifications by making $C(s)$ type 1.
\end{itemize}
\end{frame}

\begin{frame}{Closed loop transfer functions}
\begin{itemize}
\item Command to output
\begin{align*}
\frac{Y(s)}{R(s)} &= \frac{\left(K_{p}+\frac{K_{I}}{s}\right)G(s)}{1+\left(K_{p}+\frac{K_{I}}{s}\right)G(s)}\\
& = \frac{A(K_{p}s+K_{I})}{s^{3} +a_{1}s^{2} + (a_{0}+AK_{p})s + AK_{I}}
\end{align*}
\item Three poles and one zero. 
\item Poles are placed by selecting appropriate $K_{p}$ and $K_{I}$ - best to use root locus technique (next lecture).
\end{itemize}
\end{frame}

\begin{frame}{Closed loop transfer functions}
\begin{itemize}
\item Disturbance to tracking error
\begin{align*}
\frac{E(s)}{D(s)} &= -\frac{G(s)}{1+(K_{p}+\frac{K_{I}}{s})G(s)} \\
& =- \frac{As}{s^{3} +a_{1}s^{2} + (a_{0}+AK_{p})s + AK_{I}}
 \\
\end{align*}
\item If $D(s)=\frac{1}{s}$, $\lim_{t\rightarrow 0}e(t) = \frac{sA}{AK_{I}}=0$
\item Error due to step disturbance eliminated at steady state. 
\end{itemize}
\end{frame}

\section{Quiz Yourself}

\subsection{Questions}

\begin{enumerate}
\setlength{\itemsep}{5pt}
\setlength{\parskip}{0pt}
\setlength{\parsep}{0pt}
\item Design a PD controller for the plant $G(s)=\frac{1}{(s+4)s}$ so that the closed loop has a settling time of $<.8$s and overshoot $<10\%$.
\begin{center}
\input{quizfigures/system3.tex}
\end{center}
\end{enumerate}


\subsection{Solutions}
\begin{enumerate}
\setlength{\itemsep}{5pt}
\setlength{\parskip}{0pt}
\setlength{\parsep}{0pt}
\item \rule{0pt}{12pt}\\
\begin{center}
~\includegraphics[width=5in]{quizfigures/1soln}\\
\end{center}
\end{enumerate}



\end{document}


